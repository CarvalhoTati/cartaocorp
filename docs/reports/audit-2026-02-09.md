# Relatorio de Auditoria - CartaoCorp

**Data:** 2026-02-09
**Auditor:** Claude Opus 4.6 (4 agentes especializados em paralelo)
**Escopo:** Seguranca, Banco de Dados, Codigo Morto, Qualidade de Codigo

---

## Resumo Executivo

| Severidade | Seguranca | Banco | Qualidade | Dead Code | Total |
|------------|-----------|-------|-----------|-----------|-------|
| CRITICO    | 1         | 3     | 1         | 0         | **5** |
| ALTO       | 4         | 5     | 5         | 0         | **14**|
| MEDIO      | 6         | 4     | 7         | 8         | **25**|
| BAIXO      | 3         | 3     | 3         | 4         | **13**|
| **Total**  | 14        | 15    | 16        | 12        | **57**|

**Nivel de Risco Geral:** MEDIO-ALTO
**Nivel Apos Correcoes Criticas:** BAIXO

---

## Stack Identificada

- **Frontend:** Next.js 16.1.6 + React 19 + TypeScript 5
- **Estilo:** Tailwind v4 + shadcn/ui + Lucide icons
- **Backend:** Supabase (Auth + PostgreSQL + RLS + RPC)
- **Validacao:** Zod v4 + React Hook Form (parcialmente usado)
- **Graficos:** Recharts
- **Deploy:** Vercel (auto-deploy on push to main)

---

## CRITICOS (5) - Corrigir Imediatamente

### SEC-C01: Open Redirect em Auth Callback
- **Arquivo:** `src/app/auth/callback/route.ts:7-13`
- **Problema:** Parametro `next` da URL nao e validado, permitindo redirecionamento para site malicioso
- **Impacto:** Phishing, session hijacking
- **Correcao:** Validar `next` contra whitelist de paths permitidos

### DB-C01: Falta Index em `expenses.expense_date`
- **Arquivo:** `supabase/migrations/001_initial.sql`
- **Problema:** Todas as queries ordenam por `expense_date DESC` sem index
- **Impacto:** Filesort em TODAS as queries de despesas (dashboard, listagem, relatorios)
- **Correcao:** `CREATE INDEX idx_expenses_expense_date ON expenses(expense_date DESC)`

### DB-C02: RPC Functions Sem Validacao de Role
- **Arquivo:** `001_initial.sql:262`, `002_update_deposit.sql:53`
- **Problema:** Functions `SECURITY DEFINER` nao validam se usuario e admin, permitindo bypass de RLS
- **Impacto:** Usuario comum pode criar/editar depositos chamando RPC direto
- **Correcao:** Adicionar `IF NOT EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')` no inicio

### DB-C03: Race Condition em Update Deposit
- **Arquivo:** `supabase/migrations/002_update_deposit.sql:6-53`
- **Problema:** UPDATE + DELETE + INSERT sem lock (`SELECT ... FOR UPDATE`)
- **Impacto:** Dois updates simultaneos corrompem allocations
- **Correcao:** Adicionar `SELECT id FROM deposits WHERE id = p_deposit_id FOR UPDATE`

### QA-C01: Error Handling Inconsistente em Server Actions
- **Arquivos:** `src/actions/areas.ts:14`, `budget-lines.ts:10`, `cards.ts:12`
- **Problema:** Algumas actions fazem `throw new Error(error.message)` vazando detalhes do banco, outras retornam `{ error }` — sem padrao
- **Impacto:** Stack traces do Supabase expostos ao usuario + UX inconsistente
- **Correcao:** Padronizar: `console.error(error)` + retornar mensagem generica

---

## ALTOS (14) - Corrigir Antes de Producao

### Seguranca (4)

| ID | Problema | Arquivo | Correcao |
|----|----------|---------|----------|
| SEC-H01 | Server actions sem user isolation (dependem 100% de RLS) | `src/actions/*` | Adicionar verificacao de auth + role em cada action |
| SEC-H02 | Senha minima 6 chars sem complexidade | `redefinir-senha/page.tsx:26` | Zod schema com min 8 + maiuscula + numero + especial |
| SEC-H03 | Sem rate limiting em login e reset senha | `login/page.tsx`, `esqueci-senha/page.tsx` | Implementar com Upstash/Vercel KV |
| SEC-H04 | Sem security headers (CSP, X-Frame-Options) | `next.config.ts` | Adicionar headers() no next config |

### Banco de Dados (5)

| ID | Problema | Arquivo | Correcao |
|----|----------|---------|----------|
| DB-H01 | RLS policy executa subquery sem cache (N+1) | `001_initial.sql:301-339` | Criar function `is_admin()` com `STABLE` |
| DB-H02 | Falta policy UPDATE em allocations | `001_initial.sql:326-331` | Adicionar policy ou documentar imutabilidade |
| DB-H03 | View v_area_card_balance usa CROSS JOIN | `001_initial.sql:110-132` | Reescrever com UNION de sources reais |
| DB-H04 | Cascade delete de allocations sem verificar expenses | `001_initial.sql:54` | Mudar para RESTRICT ou soft delete |
| DB-H05 | Trigger check_allocation_sum e dummy (nao valida nada) | `001_initial.sql:176-189` | Remover ou implementar validacao real |

### Qualidade (5)

| ID | Problema | Arquivo | Correcao |
|----|----------|---------|----------|
| QA-H01 | N+1 query pattern em getExpenses | `expenses.ts:7-35` | Verificar com EXPLAIN; considerar raw SQL |
| QA-H02 | getExpenses sem LIMIT default (retorna TUDO) | `expenses.ts:11` | Adicionar LIMIT parametro ou default 1000 |
| QA-H03 | Promise.all no dashboard falha tudo se 1 query falhar | `dashboard/page.tsx:12-26` | Usar Promise.allSettled para queries opcionais |
| QA-H04 | Hack try/catch em getExpenses (fallback migration) | `expenses.ts:14-34` | Remover apos confirmar migration 003 aplicada |
| QA-H05 | Paginas sem loading states consistentes | `areas/page.tsx`, `cartoes/page.tsx` | Adicionar Suspense boundaries com skeletons |

---

## MEDIOS (25) - Sprint Atual

### Seguranca (6)
- **SEC-M01:** Client-side auth check bypass potential (`middleware.ts`)
- **SEC-M02:** Error messages vazam detalhes do banco (`actions/*`)
- **SEC-M03:** Sem documentacao CSRF para futuras API routes
- **SEC-M04:** Sem logging de eventos de seguranca (login falhou, delete, etc.)
- **SEC-M05:** Sem regra ESLint para `dangerouslySetInnerHTML` (preventivo)
- **SEC-M06:** Supabase anon key — verificar se .env.local esta em .gitignore

### Banco de Dados (4)
- **DB-M01:** NUMERIC(12,2) pode ser insuficiente para empresas grandes
- **DB-M02:** Falta CHECK constraint em expenses (data vs mes referencia)
- **DB-M03:** View v_budget_line_balance retorna inativos (filtra na app)
- **DB-M04:** Falta index composite em `expenses(reference_month, card_id, area_id)`

### Qualidade (7)
- **QA-M01:** Tipos `any` em tratamento de erros catch
- **QA-M02:** Views retornam NUMERIC mas TS declara `number` (precisao)
- **QA-M03:** Falta tipo para RPC return (`CreateDepositRPC`)
- **QA-M04:** Queries de balance retornam 0 em erro (deveria ser throw)
- **QA-M05:** Expense edit nao implementado (apenas create/delete)
- **QA-M06:** Filtro de mes em reports parcialmente implementado
- **QA-M07:** Trigger check_expense_balance nao valida budget_line

### Dead Code (8)
- **DC-M01:** `src/components/ui/form.tsx` — componente inteiro nao usado
- **DC-M02:** `depositSchema` e `allocationSchema` nao usados (`validations.ts`)
- **DC-M03:** `toggleCardActive` nunca chamado (`actions/cards.ts`)
- **DC-M04:** `toggleAreaActive` nunca chamado (`actions/areas.ts`)
- **DC-M05:** `getMonthlySummary` nunca chamado (`actions/reports.ts`)
- **DC-M06:** 10 tipos nao importados em `types/database.ts`
- **DC-M07:** Dependencia `date-fns` nao usada (0 imports)
- **DC-M08:** Dependencias `react-hook-form` + `@hookform/resolvers` so usadas em form.tsx (que nao e usado)

---

## BAIXOS (13) - Backlog

### Seguranca (3)
- **SEC-L01:** Sem email verification flow (signup desabilitado, preventivo)
- **SEC-L02:** Sem account lockout policy
- **SEC-L03:** JSONB inputs em deposits.ts sem validacao Zod

### Banco de Dados (3)
- **DB-L01:** Magic number em LIMIT (dashboard `.limit(10)`)
- **DB-L02:** Falta index composite em allocations(area_id, deposit_id)
- **DB-L03:** Inconsistencia nomenclatura (tudo snake_case, OK)

### Qualidade (3)
- **QA-L01:** Funcoes sem JSDoc em actions criticas
- **QA-L02:** Falta constantes para magic numbers
- **QA-L03:** Falta .env.example (setup depende de docs)

### Dead Code (4)
- **DC-L01:** `radix-ui` meta-pacote (talvez desnecessario)
- **DC-L02:** `tw-animate-css` devDependency nao verificavel
- **DC-L03:** `shadcn` devDependency CLI (pode manter)
- **DC-L04:** Imports orfaos transitivos em form.tsx

---

## Plano de Correcao

### Fase 1: Criticos (Imediato)
1. **SEC-C01** — Validar parametro `next` em auth callback
2. **DB-C02** — Adicionar validacao de role em RPC functions
3. **DB-C03** — Adicionar lock em update_deposit_with_allocations
4. **DB-C01** — Criar index em expenses.expense_date
5. **QA-C01** — Padronizar error handling em server actions

### Fase 2: Seguranca Alta (1 semana)
6. **SEC-H04** — Security headers em next.config.ts
7. **SEC-H02** — Password policy com Zod
8. **SEC-H01** — Auth helper + role check em actions
9. **SEC-H03** — Rate limiting (requer Upstash/KV)

### Fase 3: Banco e Performance (2 semanas)
10. **DB-H01** — Function is_admin() para RLS
11. **DB-H03** — Reescrever v_area_card_balance
12. **QA-H02** — LIMIT em getExpenses
13. **QA-H03** — Promise.allSettled no dashboard

### Fase 4: Limpeza (Sprint atual)
14. Remover dead code (form.tsx, deps nao usadas, funcoes orfas)
15. Remover hack try/catch em getExpenses
16. Alinhar tipos TS com schema SQL

---

## Pontos Positivos

1. **RLS implementado** em todas as tabelas com policies por role
2. **Validacao Zod** para inputs de formulario
3. **Queries parametrizadas** via Supabase query builder (zero SQL injection)
4. **Supabase Auth** gerencia hashing, sessions, cookies
5. **Transacoes atomicas** para depositos via RPC
6. **Triggers de integridade** (check_expense_balance)
7. **Middleware de autenticacao** protege rotas do app
8. **React sanitiza XSS** automaticamente (nenhum dangerouslySetInnerHTML)

---

## Metricas

| Metrica | Valor |
|---------|-------|
| Arquivos auditados | 77 |
| Problemas encontrados | 57 |
| Cobertura de testes | 0% |
| Dependencias nao usadas | 3 |
| Funcoes mortas | 3 |
| Componentes mortos | 1 |

---

## Checklist

- [ ] Backup realizado antes de correcoes
- [ ] Fase 1 (Criticos) aplicada e testada
- [ ] Fase 2 (Seguranca) aplicada e testada
- [ ] Fase 3 (Banco) aplicada com migration reversa documentada
- [ ] Fase 4 (Limpeza) aplicada
- [ ] Build limpo apos todas as fases
- [ ] Code review realizado

---

## Relatorios Detalhados

- [Security Review (OWASP Top 10)](./SECURITY-REVIEW-2026-02-09.md)

---

**Auditoria realizada por:** Claude Opus 4.6
**Agentes:** security-reviewer, database-reviewer, code-reviewer, refactor-cleaner
**Metodologia:** OWASP Top 10 + Schema Analysis + Static Code Analysis + Dead Code Detection
